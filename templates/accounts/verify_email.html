{% extends "base.html" %}

{% block title %}Verify Email - Set Invoice{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow">
        <div class="text-center">
            <i class="bi bi-envelope-check text-6xl" style="color: #05CB3A;"></i>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Verify Your Email</h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                We've sent a 6-digit code to<br>
                <span class="font-semibold" style="color: #05CB3A;">{{ user_email }}</span>
            </p>
        </div>

        <form class="mt-8 space-y-6" method="POST" id="otpForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

            <div>
                <label for="otp" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter Verification Code
                </label>
                <input type="text" name="otp" id="otp" maxlength="6" required
                    class="appearance-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:z-10 text-center text-2xl font-bold tracking-widest"
                    style="--tw-ring-color: #05CB3A;" placeholder="000000" pattern="[0-9]{6}" autocomplete="off">

                <!-- Timer Display -->
                <div class="mt-2 text-center">
                    <p class="text-sm" id="timerDisplay">
                        <i class="bi bi-clock"></i>
                        <span class="font-semibold" style="color: #05CB3A;">
                            Code expires in: <span id="countdown">60</span>s
                        </span>
                    </p>
                    <p class="text-xs text-red-600 hidden" id="expiredMessage">
                        <i class="bi bi-exclamation-circle"></i> Code expired! Please resend.
                    </p>
                </div>
            </div>

            <div>
                <button type="submit" id="verifyBtn"
                    class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2"
                    style="--tw-ring-color: #05CB3A;">
                    <i class="bi bi-check-circle mr-2"></i>
                    Verify Email
                </button>
            </div>

            <div class="text-center">
                <p class="text-sm text-gray-600">
                    Didn't receive the code?
                </p>
                <form action="{{ url('resend_otp', user_id=user_id) }}" method="POST" class="inline" id="resendForm">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <button type="submit" id="resendBtn" disabled
                        class="font-medium hover:underline disabled:opacity-50 disabled:cursor-not-allowed disabled:no-underline"
                        style="color: #05CB3A;">
                        Resend Code <span id="resendTimer">(60s)</span>
                    </button>
                </form>
            </div>
        </form>

        <div class="mt-6 p-4 bg-blue-50 rounded-md">
            <p class="text-xs text-blue-800">
                <i class="bi bi-info-circle"></i> <strong>Security Tip:</strong> Never share your verification code with
                anyone. Set Invoice will never ask for your code via phone or email.
            </p>
        </div>
    </div>
</div>

<script>
    // Auto-focus OTP input
    document.getElementById('otp').focus();

    // Only allow numbers
    document.getElementById('otp').addEventListener('input', function (e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Countdown Timer
    let timeLeft = 60; // 1 minute in seconds
    const countdownElement = document.getElementById('countdown');
    const resendBtn = document.getElementById('resendBtn');
    const resendTimer = document.getElementById('resendTimer');
    const timerDisplay = document.getElementById('timerDisplay');
    const expiredMessage = document.getElementById('expiredMessage');
    const verifyBtn = document.getElementById('verifyBtn');
    const otpInput = document.getElementById('otp');

    const timer = setInterval(function () {
        timeLeft--;
        countdownElement.textContent = timeLeft;
        resendTimer.textContent = `(${timeLeft}s)`;

        if (timeLeft <= 0) {
            clearInterval(timer);

            // Show expired message
            timerDisplay.classList.add('hidden');
            expiredMessage.classList.remove('hidden');

            // Enable resend button
            resendBtn.disabled = false;
            resendTimer.textContent = '';

            // Disable verify button
            verifyBtn.disabled = true;
            verifyBtn.classList.add('opacity-50', 'cursor-not-allowed');
            verifyBtn.innerHTML = '<i class="bi bi-x-circle mr-2"></i>Code Expired';
            
            // Remove required attribute from OTP to allow resend
            otpInput.removeAttribute('required');
            otpInput.disabled = true;
            otpInput.classList.add('opacity-50');
        }
    }, 1000);

    // Prevent form submission if expired
    document.getElementById('otpForm').addEventListener('submit', function (e) {
        if (timeLeft <= 0) {
            e.preventDefault();
            alert('OTP has expired. Please resend a new code.');
        }
    });

    // Handle resend button click
    document.getElementById('resendForm').addEventListener('submit', function (e) {
        // Show loading state
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sending...';
    });
</script>
{% endblock %}
